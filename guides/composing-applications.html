<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Composing Applications with Diesel - diesel.rs</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="A guide to diesel.rs">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">About Diesel</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Guides</li><li class="chapter-item expanded "><a href="../guides/index.html"><strong aria-hidden="true">1.</strong> Guides to Diesel</a></li><li class="chapter-item expanded "><a href="../guides/getting-started.html"><strong aria-hidden="true">2.</strong> Getting started</a></li><li class="chapter-item expanded "><a href="../guides/all-about-updates.html"><strong aria-hidden="true">3.</strong> All About Updates</a></li><li class="chapter-item expanded "><a href="../guides/all-about-inserts.html"><strong aria-hidden="true">4.</strong> All About Inserts</a></li><li class="chapter-item expanded "><a href="../guides/composing-applications.html" class="active"><strong aria-hidden="true">5.</strong> Composing Applications with Diesel</a></li><li class="chapter-item expanded "><a href="../guides/schema-in-depth.html"><strong aria-hidden="true">6.</strong> Schema in Depth</a></li><li class="chapter-item expanded "><a href="../guides/extending-diesel.html"><strong aria-hidden="true">7.</strong> Extending Diesel</a></li><li class="chapter-item expanded "><a href="../guides/configuring-diesel-cli.html"><strong aria-hidden="true">8.</strong> Configuring Diesel CLI</a></li><li class="chapter-item expanded affix "><li class="part-title">Docs</li><li class="chapter-item expanded "><a href="../docs/index.html"><strong aria-hidden="true">9.</strong> API documentation</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">diesel.rs</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/diesel-rs/diesel" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="composing-applications-with-diesel"><a class="header" href="#composing-applications-with-diesel">Composing Applications with Diesel</a></h1>
<p>One of the main benefits of using a query builder over raw SQL
is that you can pull bits of your query out into functions and reuse them.
In this guide,
we'll look at common patterns for extracting your code into re-usable pieces.
We'll also look at best practices for how to structure your code.</p>
<p>All of our code examples are based on code from crates.io,
a real world application which uses Diesel extensively.
All of our examples will be focused on functions which <em>return</em>
queries or pieces of queries.
None of these examples will include a function which takes a database
connection.
We will go into the benefits of this structure at the end of the guide.</p>
<p>crates.io has a <code>canon_crate_name</code> SQL function
which is always used when comparing crate names.
Rather than continuously writing
<code>canon_crate_name(crates::name).eq(&quot;some name&quot;)</code>,
we can instead pull this out into a function.</p>
<p>src/krate/mod.rs (<a href="https://github.com/rust-lang/crates.io/blob/b4d49ac32c5561a7a4a0948ce5ba9ada7b8924fb/src/krate/mod.rs">view on GitHub</a>):</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use diesel::dsl::Eq;
use diesel::types::Text;

sql_function!(canon_crate_name, CanonCrateName, (x: Text) -&gt; Text);

type WithName&lt;'a&gt; = Eq&lt;canon_crate_name&lt;crates::name&gt;, canon_crate_name&lt;&amp;'a str&gt;&gt;;

fn with_name(name: &amp;str) -&gt; WithName {
    canon_crate_name(crates::name).eq(canon_crate_name(name))
}
<span class="boring">}
</span></code></pre></pre>
<p>Now when we want to find a crate by name, we can write
<code>crates::table.filter(with_name(&quot;foo&quot;))</code> instead.
If we want to accept types other than a string,
we can make the method generic.</p>
<p>src/krate/mod.rs (<a href="https://github.com/rust-lang/crates.io/blob/b4d49ac32c5561a7a4a0948ce5ba9ada7b8924fb/src/krate/mod.rs">view on GitHub</a>):</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use diesel::dsl::Eq;
use diesel::types::Text;

sql_function!(canon_crate_name, CanonCrateName, (x: Text) -&gt; Text);

type WithName&lt;T&gt; = Eq&lt;canon_crate_name&lt;crates::name&gt;, canon_crate_name&lt;T&gt;&gt;;

fn with_name&lt;T&gt;(name: T) -&gt; WithName&lt;T&gt;
where
    T: AsExpression&lt;Text&gt;,
{
    canon_crate_name(crates::name).eq(canon_crate_name(name))
}
<span class="boring">}
</span></code></pre></pre>
<p>It's up to you whether you make your functions generic,
or only take a single type.
We recommend only making these functions generic if it's actually needed,
since it requires additional bounds in your <code>where</code> clause.
The bounds you need might not be clear,
unless you are familiar with Diesel's lower levels.</p>
<p>In these examples,
we are using helper types from <code>diesel::dsl</code>
to write the return type explicitly.
Nearly every method in Diesel has a helper type like this.
The first type parameter is the method receiver
(the thing before the <code>.</code>).
The remaining type parameters are the arguments to the method.
If we want to avoid writing this return type,
or dynamically return a different expression,
we can box the value instead.</p>
<p>src/krate/mod.rs (<a href="https://github.com/rust-lang/crates.io/blob/b4d49ac32c5561a7a4a0948ce5ba9ada7b8924fb/src/krate/mod.rs">view on GitHub</a>):</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use diesel::pg::Pg;
use diesel::types::Text;

sql_function!(canon_crate_name, CanonCrateName, (x: Text) -&gt; Text);

fn with_name&lt;'a, T&gt;(name: T) -&gt; Box&lt;BoxableExpression&lt;crates::table, Pg, SqlType = Bool&gt; + 'a&gt;
where
    T: AsExpression&lt;Text&gt;,
    T::Expression: BoxableExpression&lt;crates::table, Pg&gt;,
{
    canon_crate_name(crates::name).eq(canon_crate_name(name))
}
<span class="boring">}
</span></code></pre></pre>
<p>In order to box an expression, Diesel needs to know three things:</p>
<ul>
<li>The table you intend to use it on</li>
<li>The backend you plan to execute it against</li>
<li>The SQL type it represents</li>
</ul>
<p>This is all the information Diesel uses to type check your query.
Normally we can get this information from the type,
but since we've erased the type by boxing,
we have to supply it.</p>
<p>The table is used to make sure that you don't try to use <code>users::name</code>
on a query against <code>posts::table</code>.
We need to know the backend you will execute it on,
so we don't accidentally use a PostgreSQL function on SQLite.
The SQL type is needed so we know what functions this can be passed to.</p>
<p>Boxing an expression also implies that it has no aggregate functions.
You cannot box an aggregate expression in Diesel.
As of Diesel 1.0, a boxed expression can only be used with <em>exactly</em> the from
clause given.
You cannot use a boxed expression for <code>crates::table</code> with an inner join to
another table.</p>
<p>In addition to extracting expressions,
you can also pull out entire queries into functions.
Going back to crates.io,
the <code>Crate</code> struct doesn't use every column from the <code>crates</code> table.
Because we almost always select a subset of these columns,
we have an <code>all</code> function which selects the columns we need.</p>
<p>src/krate/mod.rs (<a href="https://github.com/rust-lang/crates.io/blob/b4d49ac32c5561a7a4a0948ce5ba9ada7b8924fb/src/krate/mod.rs">view on GitHub</a>):</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use diesel::dsl::Select;

type AllColumns = (
    crates::id,
    crates::name,
    crates::updated_at,
    crates::created_at,
);

const ALL_COLUMNS: AllColumns = (
    crates::id,
    crates::name,
    crates::updated_at,
    crates::created_at,
);

type All = Select&lt;crates::table, AllColumns&gt;;

impl Crate {
    pub fn all() -&gt; All {
        crates::table.select(ALL_COLUMNS)
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>We also frequently found ourselves writing
<code>Crate::all().filter(with_name(crate_name))</code>.
We can pull that into a function as well.</p>
<p>src/krate/mod.rs (<a href="https://github.com/rust-lang/crates.io/blob/b4d49ac32c5561a7a4a0948ce5ba9ada7b8924fb/src/krate/mod.rs">view on GitHub</a>):</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use diesel::dsl::Filter;

type ByName&lt;T&gt; = Filter&lt;All, WithName&lt;T&gt;&gt;;

impl Crate {
    fn by_name&lt;T&gt;(name: T) -&gt; ByName&lt;T&gt; {
        Self::all().filter(with_name(name))
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>And just like with expressions, if we don't want to write the return types,
or we want to dynamically construct the query differently, we can box the whole query.</p>
<p>src/krate/mod.rs (<a href="https://github.com/rust-lang/crates.io/blob/b4d49ac32c5561a7a4a0948ce5ba9ada7b8924fb/src/krate/mod.rs">view on GitHub</a>):</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use diesel::expression::{Expression, AsExpression};
use diesel::pg::Pg;
use diesel::types::Text;

type SqlType = &lt;AllColumns as Expression&gt;::SqlType;
type BoxedQuery&lt;'a&gt; = crates::BoxedQuery&lt;'a, Pg, SqlType&gt;;

impl Crate {
    fn all() -&gt; BoxedQuery&lt;'static&gt; {
        crates::table().select(ALL_COLUMNS).into_boxed()
    }

    fn by_name&lt;'a, T&gt;(name: T) -&gt; BoxedQuery&lt;'a&gt;
    where
        T: AsExpression&lt;Text&gt;,
        T::Expression: BoxableExpression&lt;crates::table, Pg&gt;,
    {
        Self::all().filter(by_name(name))
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>Once again, we have to give Diesel some information to box the query:</p>
<ul>
<li>The SQL type of the <code>SELECT</code> clause</li>
<li>The <code>FROM</code> clause</li>
<li>The backend you are going to execute it against</li>
</ul>
<p>The SQL type is needed so we can determine what structs can be
deserialized from this query.
The <code>FROM</code> clause is needed so we can validate the arguments
to future calls to <code>filter</code> and other query builder methods.
The backend is needed to ensure you don't accidentally use a
PostgreSQL function on SQLite.</p>
<p>Note that in all of our examples,
we are writing functions which <em>return</em> queries or expressions.
None of these functions execute the query.
In general you should always prefer functions which return queries,
and avoid functions which take a connection as an argument.
This allows you to re-use and compose your queries.</p>
<p>For example, if we had written our <code>by_name</code> function like this:</p>
<p>src/krate/mod.rs (<a href="https://github.com/rust-lang/crates.io/blob/b4d49ac32c5561a7a4a0948ce5ba9ada7b8924fb/src/krate/mod.rs">view on GitHub</a>):</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl Crate {
    fn by_name(name: &amp;str, conn: &amp;PgConnection) -&gt; QueryResult&lt;Self&gt; {
        Self::all()
            .filter(with_name(name))
            .first(conn)
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>Then we would never be able to use this query in another context,
or modify it further. By writing the function as one that returns a query,
rather than executing it, we can do things like use it as a subselect.</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let version_id = versions
    .select(id)
    .filter(crate_id.eq_any(Crate::by_name(crate_name).select(crates::id)))
    .filter(num.eq(version))
    .first(&amp;*conn)?;
<span class="boring">}
</span></code></pre></pre>
<p>Or use it to do things like get all of its downloads:
Example</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let recent_downloads = Crate::by_name(crate_name)
    .inner_join(crate_downloads::table)
    .filter(CrateDownload::is_recent())
    .select(sum(crate_downloads::downloads))
    .get_result(&amp;*conn)?;
<span class="boring">}
</span></code></pre></pre>
<p>All code in this guide is based on real code from crates.io.
You can find the source <a href="https://github.com/rust-lang/crates.io">on GitHub</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../guides/all-about-inserts.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../guides/schema-in-depth.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../guides/all-about-inserts.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../guides/schema-in-depth.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
